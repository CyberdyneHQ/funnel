
    upstream flask {
        server web:3000;
    }

    #server {
    #        listen 80;
    #        server_name funnel.hasgeek.com www.funnel.hasgeek.com funnel.hasgeek.in www.funnel.hasgeek.in;
    #        return 301 https://funnel.hasgeek.com$request_uri;
    #}

    server {
        listen 80;
        listen [::]:80;
        server_name beta.hasgeek.com;

        #  server_name hasgeek.com www.hasgeek.com hasgeek.in www.hasgeek.in;

        client_max_body_size 4G;
        keepalive_timeout 5;
        client_body_timeout 300s;

        if ($http_x_forwarded_proto != 'https') {
            return 301 https://$server_name$request_uri;
        }

        rewrite ^/jsfoo2011/(.*)$               https://jsfoo.talkfunnel.com/2011/$1    permanent;
        rewrite ^/inboxalert/(.*)$              https://inboxalert.talkfunnel.com/2013-tentative/$1    permanent;
        rewrite ^/jsfoo-bangalore2012/(.*)$     https://jsfoo.talkfunnel.com/2012-dummy/$1    permanent;
        rewrite ^/inbox-alert-2014/(.*)$        https://inboxalert.talkfunnel.com/2014/$1    permanent;
        rewrite ^/jsfoo2013/(.*)$               https://jsfoo.talkfunnel.com/2013/$1    permanent;
        rewrite ^/fifthel2013/(.*)$             https://fifthelephant.talkfunnel.com/2013/$1    permanent;
        rewrite ^/5el/(.*)$                     https://fifthelephant.talkfunnel.com/2012/$1    permanent;
        rewrite ^/cartonama/(.*)$               https://cartonama.talkfunnel.com/2012/$1    permanent;
        rewrite ^/jsfoo-pune/(.*)$              https://jsfoo.talkfunnel.com/2012-pune/$1    permanent;
        rewrite ^/metarefresh/(.*)$             https://metarefresh.talkfunnel.com/2012/$1    permanent;
        rewrite ^/jsfoo/(.*)$                   https://jsfoo.talkfunnel.com/2012/$1    permanent;
        rewrite ^/droidcon2012/(.*)$            https://droidconin.talkfunnel.com/2012/$1    permanent;
        rewrite ^/metarefresh2013/(.*)$         https://metarefresh.talkfunnel.com/2013/$1    permanent;
        rewrite ^/droidcon/(.*)$                https://droidconin.talkfunnel.com/2011/$1    permanent;
        rewrite ^/rootconf/(.*)$                https://rootconf.talkfunnel.com/2012/$1    permanent;
        rewrite ^/cartonama-workshop/(.*)$      https://cartonama.talkfunnel.com/2012-workshop/$1    permanent;
        rewrite ^/paystation/(.*)$              https://minoconf.talkfunnel.com/paystation/$1    permanent;
        rewrite ^/jsfoo-chennai/(.*)$           https://jsfoo.talkfunnel.com/2012-chennai/$1    permanent;
        rewrite ^/css-workshop/(.*)$            https://metarefresh.talkfunnel.com/2013-css-workshop/$1    permanent;
        rewrite ^/phpcloud/(.*)$                https://phpcloud.talkfunnel.com/2011/$1    permanent;
        rewrite ^/fifthel2014/(.*)$             https://fifthelephant.talkfunnel.com/2014/$1    permanent;
        rewrite ^/droidcon2014/(.*)$            https://droidconin.talkfunnel.com/2014/$1    permanent;
        rewrite ^/jsfoo2014/(.*)$               https://jsfoo.talkfunnel.com/2014/$1    permanent;
        rewrite ^/metarefresh2015/(.*)$         https://metarefresh.talkfunnel.com/2015/$1    permanent;
        rewrite ^/rootconf2014/(.*)$            https://rootconf.talkfunnel.com/2014/$1    permanent;
        rewrite ^/metarefresh2014/(.*)$         https://metarefresh.talkfunnel.com/2014/$1    permanent;
        rewrite ^/angularjs-miniconf-2014/(.*)$ https://minoconf.talkfunnel.com/2014-angularjs/$1    permanent;
        rewrite ^/droidcon2013/(.*)$            https://droidconin.talkfunnel.com/2013/$1    permanent;
        rewrite ^/redis-miniconf-2014/(.*)$     https://minoconf.talkfunnel.com/2014-redis/$1    permanent;
        rewrite ^/rootconf-miniconf-2014/(.*)$  https://miniconf.talkfunnel.com/2014-rootconf/$1    permanent;


        # TODO: Add serverdown fallback

        # Proxy connections to flask
        location / {
            include uwsgi_params;
            uwsgi_pass http://flask;
            uwsgi_read_timeout 60s;
            uwsgi_send_timeout 60s;
            uwsgi_connect_timeout 60s;
            #proxy_pass http://flask;
            #proxy_redirect     off;
            #proxy_set_header Host              $host;
            #proxy_set_header X-Real-IP         $remote_addr;
            #proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            #proxy_set_header X-Forwarded-Proto $scheme;
            #proxy_set_header X-Forwarded-Host  $host;
            #proxy_set_header X-Forwarded-Port  $server_port;
            #proxy_ignore_client_abort on;
            #proxy_connect_timeout   100;
            #proxy_send_timeout      150;
            #proxy_read_timeout      200;
        }
    }
